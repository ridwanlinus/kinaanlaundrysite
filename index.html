<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifikasi Pesanan Laundry Real-Time</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        /* Style untuk notifikasi new (baru) */
        .new-order {
            animation: fadeIn 0.5s ease-out;
            border-left: 5px solid #10b981; /* green-500 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="loadingIndicator" class="text-center p-4 text-gray-500">Memuat data dan mengautentikasi...</div>

    <div id="mainContent" class="hidden max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Papan Notifikasi Pesanan Laundry</h1>
            <p class="text-gray-500">Lihat pesanan baru secara real-time dari Google Sheet.</p>
            <div id="userIdDisplay" class="mt-4 p-2 bg-indigo-100 text-indigo-800 text-xs rounded-lg inline-block">
                <!-- User ID akan ditampilkan di sini -->
            </div>
        </header>

        <section id="ordersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Kartu pesanan akan dimasukkan di sini oleh JavaScript -->

            <!-- Contoh Kartu Pesanan (Hanya untuk Pratinjau Tampilan) -->
            <div class="card p-5 rounded-xl bg-white new-order">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">PESANAN BARU</span>
                    <button data-order-id="example-1" class="btn-mark-done text-xs text-gray-500 hover:text-indigo-600 transition">
                        Tandai Selesai
                    </button>
                </div>
                <h2 class="text-xl font-bold text-gray-800">Budi Santoso</h2>
                <p class="text-gray-600 mb-2">Cuci Kering (${4.5} kg)</p>
                <div class="text-sm text-gray-500 space-y-1">
                    <p><strong class="font-medium text-gray-700">Telepon:</strong> 081234567890</p>
                    <p><strong class="font-medium text-gray-700">Alamat:</strong> Jl. Mawar No. 12, Jakarta</p>
                    <p><strong class="font-medium text-gray-700">Waktu:</strong> 20 Nov 2025, 13:00</p>
                </div>
            </div>
            <!-- Akhir Contoh Kartu Pesanan -->

        </section>

        <section id="emptyState" class="hidden text-center mt-16 p-8 bg-white rounded-xl card">
            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Belum ada pesanan</h3>
            <p class="mt-1 text-sm text-gray-500">Tambahkan entri baru di Google Sheet Anda untuk melihatnya muncul di sini!</p>
        </section>

        <!-- Pesan error -->
        <div id="errorMessage" class="hidden fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-lg card transition duration-300">
            Terjadi kesalahan! Lihat konsol.
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Atur log level untuk melihat pesan debug dari Firestore
        setLogLevel('Debug');

        // Variabel global dari lingkungan Canvas (WAJIB DIGUNAKAN)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const loadingIndicator = document.getElementById('loadingIndicator');
        const mainContent = document.getElementById('mainContent');
        const ordersContainer = document.getElementById('ordersContainer');
        const emptyState = document.getElementById('emptyState');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const errorMessageDiv = document.getElementById('errorMessage');

        if (!firebaseConfig) {
            console.error("Firebase config tidak tersedia. Aplikasi tidak dapat berjalan.");
            loadingIndicator.textContent = "Error: Konfigurasi Firebase tidak ditemukan.";
        } else {
            // --- 1. INISIALISASI FIREBASE ---
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Fungsi untuk menampilkan pesan error singkat di UI
            function showErrorMessage(message) {
                console.error(message);
                errorMessageDiv.textContent = `Error: ${message}`;
                errorMessageDiv.classList.remove('hidden');
                setTimeout(() => {
                    errorMessageDiv.classList.add('hidden');
                }, 5000);
            }

            // Fungsi untuk mengautentikasi pengguna
            async function authenticateUser() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    showErrorMessage("Gagal autentikasi Firebase. " + error.message);
                }
            }

            // --- 2. PENANGANAN AUTHENTIKASI DAN SETUP REAL-TIME LISTENER ---
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.classList.add('hidden');
                mainContent.classList.remove('hidden');

                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID Anda: ${userId}`;
                    isAuthReady = true;
                    // Mulai mendengarkan data setelah autentikasi selesai
                    setupRealtimeListener();
                } else {
                    isAuthReady = true; // Selesai cek auth
                    userId = crypto.randomUUID(); // ID sementara jika anonim/gagal
                    userIdDisplay.textContent = `Mode Anonim (ID: ${userId}).`;
                    // Meskipun anonim, kita tetap mencoba mendengarkan data publik.
                    setupRealtimeListener();
                }
            });

            // Panggil autentikasi saat aplikasi dimuat
            authenticateUser();

            // Path koleksi publik untuk data pesanan
            // Data ini bersifat PUBLIK sehingga Google Apps Script bisa menulis ke sini.
            const PUBLIC_ORDERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/laundry_orders`;

            // --- 3. FUNGSI UNTUK MERENDER DATA ---
            function renderOrders(orders) {
                ordersContainer.innerHTML = ''; // Kosongkan kontainer
                const hasOrders = orders.length > 0;
                emptyState.classList.toggle('hidden', hasOrders);
                ordersContainer.classList.toggle('hidden', !hasOrders);

                // Urutkan berdasarkan waktu_pesanan (paling baru di atas)
                const sortedOrders = orders.sort((a, b) => new Date(b.waktu_pesanan) - new Date(a.waktu_pesanan));

                sortedOrders.forEach(order => {
                    const orderCard = document.createElement('div');
                    orderCard.className = `card p-5 rounded-xl bg-white new-order`; // Tambahkan class animasi
                    orderCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-semibold text-green-600 bg-green-100 px-3 py-1 rounded-full">PESANAN BARU</span>
                            <button data-order-id="${order.id}" class="btn-mark-done text-xs text-gray-500 hover:text-indigo-600 transition">
                                Tandai Selesai
                            </button>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">${order.nama_pelanggan}</h2>
                        <p class="text-gray-600 mb-2">${order.layanan} (${order.berat_kg || '?'} kg)</p>
                        <div class="text-sm text-gray-500 space-y-1">
                            <p><strong class="font-medium text-gray-700">Telepon:</strong> ${order.telepon}</p>
                            <p><strong class="font-medium text-gray-700">Alamat:</strong> ${order.alamat}</p>
                            <p><strong class="font-medium text-gray-700">Waktu:</strong> ${new Date(order.waktu_pesanan).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                    `;
                    ordersContainer.appendChild(orderCard);
                });

                // Tambahkan event listener untuk tombol "Tandai Selesai"
                document.querySelectorAll('.btn-mark-done').forEach(button => {
                    button.addEventListener('click', handleMarkDone);
                });

                // Putar suara notifikasi saat ada entri baru
                try {
                    const audio = new Audio('https://s3.amazonaws.com/iam-the-real/files/ding.mp3');
                    audio.play();
                } catch (e) {
                    console.warn("Gagal memutar audio notifikasi:", e);
                }
            }

            // Fungsi untuk menangani penandaan selesai
            async function handleMarkDone(event) {
                const orderId = event.target.dataset.orderId;
                if (!orderId) return;

                // Dapatkan referensi dokumen
                const docRef = doc(db, PUBLIC_ORDERS_COLLECTION_PATH, orderId);

                try {
                    // Update status pesanan di Firestore
                    await setDoc(docRef, {
                        status: 'Selesai',
                        waktu_selesai: new Date().toISOString()
                    }, { merge: true }); // Merge agar tidak menimpa data lain

                    // Hilangkan card dari tampilan (karena listener onSnapshot akan melakukannya)
                    // Tapi untuk UX yang lebih cepat, kita bisa langsung hilangkan/ubah gayanya
                    event.target.closest('.card').remove();
                    console.log(`Pesanan ${orderId} berhasil ditandai Selesai.`);

                } catch (e) {
                    showErrorMessage(`Gagal memperbarui pesanan ${orderId}: ${e.message}`);
                }
            }


            // --- 4. LISTENER REAL-TIME (onSnapshot) ---
            function setupRealtimeListener() {
                if (!isAuthReady) {
                    console.warn("Autentikasi belum siap. Listener tidak dipasang.");
                    return;
                }

                console.log("Memasang listener real-time pada koleksi publik:", PUBLIC_ORDERS_COLLECTION_PATH);

                // Membuat Query: Ambil semua pesanan yang statusnya 'Baru'
                const q = query(
                    collection(db, PUBLIC_ORDERS_COLLECTION_PATH),
                    // Kita hanya ingin pesanan yang statusnya 'Baru' (atau belum ada status)
                    // Kita asumsikan Google Apps Script akan menetapkan 'Baru'
                    // Kita akan filter pesanan yang *tidak* memiliki status 'Selesai'
                    // Karena Firestore tidak mendukung query OR pada value yang sama,
                    // kita akan filter di sisi klien saja setelah data diurutkan.
                );


                // Memasang listener
                onSnapshot(collection(db, PUBLIC_ORDERS_COLLECTION_PATH), (snapshot) => {
                    const orders = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        // Filter di sisi klien: hanya tampilkan yang statusnya BUKAN 'Selesai'
                        if (data.status !== 'Selesai') {
                            orders.push({ id: doc.id, ...data });
                        }
                    });

                    console.log("Data pesanan real-time diperbarui. Jumlah pesanan baru:", orders.length);
                    renderOrders(orders);

                }, (error) => {
                    showErrorMessage("Gagal mengambil data real-time: " + error.message);
                });
            }
        }

    </script>
</body>
</html>
